# EasyArchitect V2 Lab8 - 租車系統 Web API Framework

## 📋 專案概述
本專案是一個基於 **Clean Architecture（清潔架構）** 與 **Hexagonal Architecture（六角架構）** 的現代化 Web API Framework，主要用於租車業務系統的開發。採用 ASP.NET Core 8.0 技術棧，結合 JWT 身分驗證、AOP 橫切面程式設計，以及完整的日誌記錄機制。

## 🏗️ 系統架構

### 架構模式
- **Clean Architecture（清潔架構）**
- **Hexagonal Architecture（六角架構）**
- **Domain-Driven Design (DDD) 概念**
- **Port-Adapter 模式**

### 分層結構
```
├── Presentation Layer (表現層)
│   ├── RentalCar8.Web8                      # ASP.NET Core Web 主專案
│   └── EasyArchitectV2Lab8.ApiControllerBase8  # API Controller 基底類別
├── Application Layer (應用層)
│   └── RentalCar8.Application8              # 應用服務與 Use Cases
│       ├── port/In/                         # 輸入埠 (Input Ports)
│       └── port/Out/                        # 輸出埠 (Output Ports)
├── Domain Layer (領域層)
│   └── RentalCar8.Domain8                   # 領域實體與商業邏輯
└── Infrastructure Layer (基礎設施層)
    ├── RentalCar8.Infrastructure8           # 資料存取層
    ├── EasyArchitectV2Lab8.AuthExtensions8 # 身分驗證服務
    └── AOP.ApiControllerBase.ApiLog8        # AOP 橫切面功能
```

## 🛠️ 技術規格

### 核心技術
- **.NET 8.0** - 目標框架
- **ASP.NET Core 8.0** - Web 框架
- **C# 12.0** - 程式語言
- **Entity Framework Core 8.0** - ORM 框架
- **SQL Server** - 資料庫

### 身分驗證與授權
- **JWT (JSON Web Token)** - 主要身分驗證方式
- **Cookie Authentication** - 輔助身分驗證
- **自訂授權過濾器** - NeedAuthorizeAttribute
- **Token 驗證中間件** - JwtService

### 日誌記錄
- **NLog 4.7.13** - 日誌框架
- **AOP 日誌記錄** - ApiLogonInfoAttribute, ApiLogExceptionAttribute
- **結構化日誌** - 包含執行時間、使用者資訊、錯誤追蹤

### 依賴注入
- **內建 DI 容器** - ASP.NET Core DI
- **Scoped 生命週期管理**
- **介面導向程式設計**

## 📊 控制器與 API 方法統計

### MVC Controllers: 1 個
1. **HomeController** (傳統 MVC Controller)
   - `Index()` - 首頁檢視
   - `Privacy()` - 隱私權頁面
   - `Error()` - 錯誤頁面

### Web API Controllers: 2 個

#### 1. EasyArchiectV2ControllerBase (基底控制器)
- **API 方法數量: 1 個**
- `POST /api/EasyArchiectV2ControllerBase/Login` - 使用者登入驗證

#### 2. RentalCarApiController (租車 API 控制器)
- **API 方法數量: 2 個 (1 個註解)**
- `GET /api/RentalCarApi/GetPersons` - 取得人員清單 (需要驗證)
- `GET /api/RentalCarApi/GetAllCars` - 取得所有可出租車輛
- `POST /api/RentalCarApi/ToRentalCar` - 租車作業 (已註解)

### Web API 方法功能說明

| HTTP Method | Route | 功能說明 | 授權需求 | AOP 功能 |
|-------------|-------|----------|----------|----------|
| POST | `/api/EasyArchiectV2ControllerBase/Login` | 使用者身分驗證登入 | ❌ | ❌ |
| GET | `/api/RentalCarApi/GetPersons` | 取得人員清單 (範例) | ✅ | ✅ 日誌+例外 |
| GET | `/api/RentalCarApi/GetAllCars` | 取得所有可出租車輛清單 | ❌ | ✅ 日誌+例外 |

**總計: 3 個 Web API 方法 (2 個啟用，1 個註解)**

## 📄 檢視表 (Views) 統計

### Razor Views: 7 個檢視檔案

#### 頁面檢視 (3 個)
1. `Views/Home/Index.cshtml` - 首頁
2. `Views/Home/Privacy.cshtml` - 隱私權頁面
3. `Views/Shared/Error.cshtml` - 錯誤頁面

#### 共用檢視 (4 個)
1. `Views/Shared/_Layout.cshtml` - 主要版面配置
2. `Views/Shared/_Layout.cshtml.css` - 版面樣式
3. `Views/Shared/_ValidationScriptsPartial.cshtml` - 驗證腳本
4. `Views/_ViewImports.cshtml` - 檢視匯入設定
5. `Views/_ViewStart.cshtml` - 檢視啟動設定

**總計: 7 個 Razor 檢視檔案**

## 🎯 AOP 橫切面功能

### 過濾器 (Filters)
1. **ApiLogonInfoAttribute** - API 呼叫日誌記錄
   - 記錄 API 執行時間
   - 記錄使用者資訊
   - 記錄請求來源

2. **ApiLogExceptionAttribute** - 例外錯誤日誌
   - 捕捉 API 執行例外
   - 記錄錯誤堆疊追蹤
   - 結構化錯誤資訊

3. **NeedAuthorizeAttribute** - 授權驗證
   - JWT Token 驗證
   - 使用者權限檢查
   - 未授權回應處理

## 🔧 專案結構詳細說明

### 核心專案 (11 個)

#### 表現層 (Presentation)
- **RentalCar8.Web8** - 主要 Web 應用程式 (Razor Pages + Web API)

#### 應用層 (Application)  
- **RentalCar8.Application8** - 應用服務、Use Cases、Port 定義

#### 領域層 (Domain)
- **RentalCar8.Domain8** - 領域實體、商業邏輯、介面定義

#### 基礎設施層 (Infrastructure)
- **RentalCar8.Infrastructure8** - 資料存取、外部服務整合

#### 框架支援專案
- **EasyArchitectV2Lab8.ApiControllerBase8** - API Controller 基底類別
- **EasyArchitectV2Lab8.AuthExtensions8** - 身分驗證擴充服務
- **EasyArchitectV2Lab8.JWTMiddleware8** - JWT 中間件服務
- **EasyArchitectV2Lab8.Configuration8** - 組態設定服務
- **AOP.ApiControllerBase.ApiLog8** - AOP 日誌記錄套件

#### 測試專案
- **RentalCar8.Domain8Tests** - 領域層單元測試

#### 擴充專案
- **EasyArchitectV2Lab8.AuthExtensions8.Extensions** - 驗證擴充功能

## 🚀 系統特色

### 1. 清潔架構實作
- 依賴反轉原則 (DIP)
- 關注點分離 (SoC)
- 高內聚低耦合

### 2. 現代化身分驗證
- JWT Token 機制
- 自動 Token 驗證中間件
- 靈活的授權控制

### 3. 完整日誌系統
- 結構化日誌記錄
- 效能監控 (執行時間追蹤)
- 錯誤追蹤與堆疊記錄

### 4. 企業級開發模式
- 依賴注入容器
- AOP 橫切面程式設計
- Port-Adapter 模式
- Use Case 驅動開發

## 📦 套件專案
本方案包含多個可重複使用的 NuGet 套件專案：
- `EasyArchitectV2Lab8.ApiControllerBase8` v8.0.0
- `EasyArchitectV2Lab8.AuthExtensions8` v8.0.0  
- `AOP.ApiControllerBase.ApiLog8` v8.0.0

## 🎯 使用場景
- 企業級 Web API 開發
- 微服務架構實作
- 租車/車輛管理系統
- 需要完整身分驗證的業務系統
- 教學用現代化 .NET 架構範例

## 📋 開發環境需求
- Visual Studio 2022 或 Visual Studio Code
- .NET 8.0 SDK
- SQL Server (LocalDB 或完整版)
- IIS Express 或 Kestrel

---
*此專案採用 Clean Architecture 設計原則，適合作為企業級 Web API Framework 的學習與實作參考。*